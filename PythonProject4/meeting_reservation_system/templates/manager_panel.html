<!DOCTYPE html>
<html>
<head>
    <title>–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .back-button {
            background: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .booking-card {
    background: #2d2d2d;
    padding: 20px;
    margin: 10px 0;
    border-radius: 10px;
    border: 1px solid #404040;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex; /* ‚òÖ‚òÖ‚òÖ –í–°–ï–ì–î–ê FLEX ‚òÖ‚òÖ‚òÖ */
    flex-direction: column; /* ‚òÖ‚òÖ‚òÖ –í–°–ï–ì–î–ê COLUMN ‚òÖ‚òÖ‚òÖ */
}
        .booking-card:hover {
            border-color: #007bff;
        }
        .booking-card.expanded {
            background: #3a3a3a;
        }
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .booking-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .booking-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #404040;
        }
        .booking-card.expanded .booking-details {
            display: block;
        }
        .expand-icon {
            transition: transform 0.3s ease;
        }
        .booking-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        .status-pending { color: #ffc107; }
        .status-confirmed { color: #28a745; }
        .status-cancelled { color: #dc3545; }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn-confirm { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .filters {
            margin: 20px 0;
            display: flex;
            gap: 15px;
        }
        .filter-select {
            padding: 8px;
            background: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 5px;
        }
        .btn-delete {
            background: #6c757d !important;
            color: white !important;
        }
        .btn-delete:hover {
            background: #5a6268 !important;
        }
        .room-category {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid;
        }
        .category-economy {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #28a745;
        }
        .category-standard {
            background: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
            color: #007bff;
        }
        .category-comfort {
            background: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: #ffc107;
        }
        .category-vip {
            background: rgba(108, 92, 231, 0.1);
            border-color: #6c5ce7;
            color: #6c5ce7;
        }
        .category-luxury {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
        }
        .preview-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .preview-info div {
            font-size: 14px;
            color: #ccc;
        }
    </style>
</head>
<body>

<button class="back-button" onclick="window.history.back()">‚Üê –ù–∞–∑–∞–¥</button>

<h1>üìã –ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters">
    <select class="filter-select" onchange="filterBookings()">
        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</option>
        <option value="confirmed">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
        <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
    </select>

    <select class="filter-select" onchange="filterByRoom()">
        <option value="all">–í—Å–µ –∫–æ–º–Ω–∞—Ç—ã</option>
        {% for room in rooms %}
        <option value="{{ room.id }}">{{ room.name }}</option>
        {% endfor %}
    </select>

    <select class="filter-select" onchange="filterByCategory()">
        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="economy">üü¢ –≠–∫–æ–Ω–æ–º</option>
        <option value="standard">üîµ –°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
        <option value="comfort">üü° –ö–æ–º—Ñ–æ—Ä—Ç</option>
        <option value="vip">üü£ VIP</option>
        <option value="luxury">üî¥ –õ—é–∫—Å</option>
    </select>
</div>

<!-- –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
<div id="bookings-list">
    {% for booking in bookings %}
    <div class="booking-card" data-status="{{ booking.status }}" data-room="{{ booking.room.id }}" data-category="{{ booking.room.category }}" onclick="toggleBooking(this)">
        <div class="booking-header">
            <div class="booking-preview">
                <div>
                    <h3 style="margin: 0 0 5px 0;">
                        {% if booking.room.category == 'economy' %}üü¢
                        {% elif booking.room.category == 'standard' %}üîµ
                        {% elif booking.room.category == 'comfort' %}üü°
                        {% elif booking.room.category == 'vip' %}üü£
                        {% elif booking.room.category == 'luxury' %}üî¥
                        {% endif %}
                        {{ booking.room.name }}
                        | üë§ {{ booking.user.username }}
                    </h3>
                    <div class="preview-info">
                        <div><strong>üìÖ</strong> {{ booking.date_display }}</div>
                        <div><strong>‚è∞</strong> {{ booking.time_display }}</div>
                        <div><strong>üí∞</strong> {{ booking.total_price }} —Ä—É–±</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="room-category
                        {% if booking.room.category == 'economy' %}category-economy
                        {% elif booking.room.category == 'standard' %}category-standard
                        {% elif booking.room.category == 'comfort' %}category-comfort
                        {% elif booking.room.category == 'vip' %}category-vip
                        {% elif booking.room.category == 'luxury' %}category-luxury{% endif %}">
                        {% if booking.room.category == 'economy' %}üü¢ –≠–∫–æ–Ω–æ–º
                        {% elif booking.room.category == 'standard' %}üîµ –°—Ç–∞–Ω–¥–∞—Ä—Ç
                        {% elif booking.room.category == 'comfort' %}üü° –ö–æ–º—Ñ–æ—Ä—Ç
                        {% elif booking.room.category == 'vip' %}üü£ VIP
                        {% elif booking.room.category == 'luxury' %}üî¥ –õ—é–∫—Å{% endif %}
                    </span>
                    <span class="status-{{ booking.status }}">
                        {{ booking.get_status_display }}
                    </span>
                    <span class="expand-icon">‚ñº</span>
                </div>
            </div>
        </div>

        <div class="booking-details">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <p><strong>‚è±Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ booking.duration_hours }} —á–∞—Å–∞</p>
                    <p>
                        <strong>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</strong>
                        <input type="number" id="price-{{ booking.id }}" value="{{ booking.total_price }}"
                               onclick="event.stopPropagation()"
                               style="width: 120px; padding: 4px; background: #2d2d2d; color: #e0e0e0; border: 1px solid #404040;">
                        —Ä—É–±
                    </p>
                    <p><strong>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong> {{ booking.user.phone|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }} | {{ booking.user.email }}</p>
                </div>
                <div>
                    {% if booking.description %}
                    <p><strong>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞:</strong><br>{{ booking.description }}</p>
                    {% endif %}
                <p>
                    <strong>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong><br>

                    {% if booking.status == 'pending' %}
                        <!-- –î–ª—è –æ–∂–∏–¥–∞—é—â–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π - –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
                        <textarea id="manager-comment-{{ booking.id }}"
                          onclick="event.stopPropagation()"
                          style="width: 100%; height: 60px; padding: 8px;
                                 background: #2d2d2d; color: #e0e0e0;
                                 border: 1px solid #007bff; border-radius: 6px;
                                 resize: vertical;"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏...">{{ booking.manager_comment|default:"" }}</textarea>
                    {% else %}
                        <!-- –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö/–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö - —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä -->
                        {% if booking.manager_comment %}
                            <div style="width: 100%; min-height: 50px; padding: 12px;
                                        background: #2d2d2d;
                                        color: #e0e0e0;
                                        border: 1px solid #555;
                                        border-radius: 8px;
                                        white-space: pre-wrap;
                                        margin-top: 5px;">
                                üí¨ {{ booking.manager_comment }}
                            </div>
                        {% else %}
                            <div style="width: 100%; min-height: 50px; padding: 12px;
                                        background: rgba(108, 117, 125, 0.1);
                                        color: #6c757d;
                                        border: 1px dashed #6c757d;
                                        border-radius: 8px;
                                        white-space: pre-wrap;
                                        font-style: italic;
                                        margin-top: 5px;">
                                üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                            </div>
                        {% endif %}
                    {% endif %}
                </p>
                </div>
            </div>

            {% if booking.status == 'pending' %}
            <div class="booking-actions">
                <button class="btn btn-confirm" onclick="event.stopPropagation(); updateBookingStatus({{ booking.id }}, 'confirmed')">
                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
                <button class="btn btn-cancel" onclick="event.stopPropagation(); updateBookingStatus({{ booking.id }}, 'cancelled')">
                    ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                </button>
            </div>
            {% else %}
            <div class="booking-actions">
                <button class="btn btn-delete" onclick="event.stopPropagation(); deleteBooking({{ booking.id }})"
                        style="background: #6c757d; color: white;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>

                {% if booking.status == 'confirmed' %}
                <button class="btn btn-cancel" onclick="event.stopPropagation(); updateBookingStatus({{ booking.id }}, 'cancelled')">
                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="booking-card">
        <p>üì≠ –ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>
    </div>
    {% endfor %}
</div>

<script>
    function toggleBooking(card) {
        card.classList.toggle('expanded');
    }

    function filterByCategory() {
    const category = event.target.value;
    const bookings = document.querySelectorAll('.booking-card');

    bookings.forEach(booking => {
        if (category === 'all' || booking.dataset.category === category) {
            booking.style.display = 'flex'; // ‚òÖ‚òÖ‚òÖ –í–°–ï–ì–î–ê FLEX ‚òÖ‚òÖ‚òÖ
        } else {
            booking.style.display = 'none';
        }
    });
}

    function deleteBooking(bookingId) {
        if (!confirm('‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
            return;
        }

        fetch(`/api/delete-booking/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        });
    }

    function updateBookingStatus(bookingId, newStatus) {
    let newPrice = document.getElementById(`price-${bookingId}`)?.value || null;
    let managerComment = "";

    // ‚òÖ‚òÖ‚òÖ –ë–ï–†–ï–ú –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –¢–û–õ–¨–ö–û –ï–°–õ–ò –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï –ë–´–õ–û –í –û–ñ–ò–î–ê–ù–ò–ò ‚òÖ‚òÖ‚òÖ
    if (newStatus !== 'pending') {
        managerComment = document.getElementById(`manager-comment-${bookingId}`)?.value || "";
    }

    fetch(`/api/update-booking-status/${bookingId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            status: newStatus,
            total_price: newPrice,
            manager_comment: managerComment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("–ì–æ—Ç–æ–≤–æ!");
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    });
}

    function filterBookings() {
    const status = event.target.value;
    const bookings = document.querySelectorAll('.booking-card');

    bookings.forEach(booking => {
        if (status === 'all' || booking.dataset.status === status) {
            booking.style.display = 'flex'; // ‚òÖ‚òÖ‚òÖ –í–°–ï–ì–î–ê FLEX ‚òÖ‚òÖ‚òÖ
        } else {
            booking.style.display = 'none';
        }
    });
}

function filterByRoom() {
    const roomId = event.target.value;
    const bookings = document.querySelectorAll('.booking-card');

    bookings.forEach(booking => {
        if (roomId === 'all' || booking.dataset.room === roomId) {
            booking.style.display = 'flex'; // ‚òÖ‚òÖ‚òÖ –í–°–ï–ì–î–ê FLEX ‚òÖ‚òÖ‚òÖ
        } else {
            booking.style.display = 'none';
        }
    });
}

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.booking-card')) {
            document.querySelectorAll('.booking-card.expanded').forEach(card => {
                card.classList.remove('expanded');
            });
        }
    });
</script>

</body>
</html>