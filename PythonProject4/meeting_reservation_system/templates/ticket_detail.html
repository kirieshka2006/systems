<div class="ticket-detail">
    <h3>{{ ticket.subject }}</h3>

    <div class="ticket-info">
<div style="margin-bottom: 20px;">
    <div>
        <strong>üë§ –ê–≤—Ç–æ—Ä:</strong> {{ ticket.user.username }}<br>
        <strong>üìÖ –°–æ–∑–¥–∞–Ω:</strong> {{ ticket.created_at|date:"d.m.Y H:i" }}<br>
        <strong>üîÑ –°—Ç–∞—Ç—É—Å:</strong>
        <span class="ticket-status status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
    </div>
</div>
        <div style="color: #999; font-size: 12px; margin-top: 5px;">
            {% if ticket.status == 'in_progress' %}
            ‚è∞ –ë—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            {% elif ticket.status == 'closed' %}
            üü¢ –¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç
            {% endif %}
        </div>

        <div class="ticket-message" style="background: #3a3a3a; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #007bff;">
            <strong style="color: #fff;">üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</strong><br>
            <div style="margin-top: 10px; color: #e0e0e0; line-height: 1.6;">
                {{ ticket.message|linebreaks }}
            </div>
        </div>
    </div>

    <!-- –û–¢–í–ï–¢–´ -->
    <div class="response-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #fff;">üí¨ –û—Ç–≤–µ—Ç—ã ({{ ticket.responses.count }})</h4>
            {% if ticket.status != 'closed' %}
                {% if user.role in 'admin manager' or user == ticket.user %}
                <button class="btn-reply" onclick="window.parent.showResponseForm({{ ticket.id }}, '{{ ticket.subject|escapejs }}')">
                    ‚ú® –û—Ç–≤–µ—Ç–∏—Ç—å
                </button>
                {% endif %}
            {% endif %}
        </div>

        <div class="responses-list">
            {% for response in ticket.responses.all %}
            <div class="response-item" style="animation: fadeIn 0.5s ease-in;">
                <div class="response-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: {% if response.user.role in 'admin manager' %}#007bff{% else %}#28a745{% endif %}; display: flex; align-items: center; justify-content: center; font-size: 14px; color: white;">
                            {% if response.user.role in 'admin manager' %}üõ†Ô∏è{% else %}üë§{% endif %}
                        </div>
                        <div>
                            <strong style="color: #fff;">
                                {% if response.user.role in 'admin manager' %}–ü–æ–¥–¥–µ—Ä–∂–∫–∞{% else %}{{ response.user.username }}{% endif %}
                            </strong>
                            <div style="color: #999; font-size: 12px;">{{ response.created_at|date:"d.m.Y H:i" }}</div>
                        </div>
                    </div>
                </div>
                <div class="response-content" style="margin-top: 10px; padding: 15px; background: #3a3a3a; border-radius: 8px; border: 1px solid #555;">
                    {{ response.message|linebreaks }}
                </div>
            </div>
            {% empty %}
            <div class="no-responses" style="text-align: center; padding: 40px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ</p>
                {% if ticket.status != 'closed' %}
                    {% if user.role in 'admin manager' or user == ticket.user %}
                    <button class="btn-reply" onclick="window.parent.showResponseForm({{ ticket.id }}, '{{ ticket.subject|escapejs }}')">
                        üíå –ù–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç
                    </button>
                    {% endif %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- –ö–ù–û–ü–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø -->
    {% if user == ticket.user and ticket.status != 'closed' %}
    <div style="margin-top: 30px; padding: 20px; background: #2d2d2d; border-radius: 10px; border: 1px solid #404040; text-align: center;">
        <h4 style="color: #fff; margin-bottom: 15px;">‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞?</h4>
        <p style="color: #ccc; margin-bottom: 20px;">–ï—Å–ª–∏ –≤–∞—à –≤–æ–ø—Ä–æ—Å —Ä–µ—à–µ–Ω, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</p>
        <form method="POST" action="{% url 'close_ticket' ticket.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-close-ticket"
                    style="background: linear-gradient(135deg, #28a745, #218838);
                           color: white; padding: 12px 30px; border: none;
                           border-radius: 8px; cursor: pointer; font-size: 14px;
                           font-weight: bold; transition: all 0.3s ease;">
                ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ - –∑–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ
            </button>
        </form>
    </div>
    {% endif %}

    <!-- –°–û–û–ë–©–ï–ù–ò–ï –û –ó–ê–ö–†–´–¢–û–ú –¢–ò–ö–ï–¢–ï -->
    {% if ticket.status == 'closed' %}
    <div style="margin-top: 30px; padding: 20px; background: #2d2d2d; border-radius: 10px; border: 2px solid #28a745; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 10px;">üîí</div>
        <h4 style="color: #28a745; margin-bottom: 10px;">–¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç</h4>
        <p style="color: #ccc;">–≠—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ù–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è.</p>
        {% if user == ticket.user %}
        <p style="color: #999; font-size: 14px; margin-top: 10px;">
            –í—ã –∑–∞–∫—Ä—ã–ª–∏ —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –û–¢–í–ï–¢–ê -->


<style>

.btn-close-ticket:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40,167,69,0.3);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.btn-reply {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

.btn-reply:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,123,255,0.4);
}



.response-item {
    margin-bottom: 20px;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
// ‚òÖ‚òÖ‚òÖ –î–û–ë–ê–í–¨ –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê ‚òÖ‚òÖ‚òÖ






// ‚òÖ‚òÖ‚òÖ –î–û–ë–ê–í–¨ –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–ë–´–¢–ò–ô –î–õ–Ø –§–û–†–ú–´ ‚òÖ‚òÖ‚òÖ
document.addEventListener('DOMContentLoaded', function() {
    const responseForm = document.getElementById('responseForm');
    if (responseForm) {
        responseForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            submitBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            submitBtn.disabled = true;

            const formData = new FormData(this);

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    showNotification('‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                    closeResponseModal();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }

    // ‚òÖ‚òÖ‚òÖ –î–û–ë–ê–í–¨ –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ‚òÖ‚òÖ‚òÖ
    window.onclick = function(event) {
        const modal = document.getElementById('responseModal');
        if (event.target === modal) {
            closeResponseModal();
        }
    }

    // ‚òÖ‚òÖ‚òÖ –î–û–ë–ê–í–¨ –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ö–õ–ê–í–ò–®–ò ESC ‚òÖ‚òÖ‚òÖ
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeResponseModal();
        }
    });
});

// ‚òÖ‚òÖ‚òÖ –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ‚òÖ‚òÖ‚òÖ
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>