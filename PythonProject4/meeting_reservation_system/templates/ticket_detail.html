<div class="ticket-detail">
    <h3>{{ ticket.subject }}</h3>

    <div class="ticket-info">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div>
                <strong>üë§ –ê–≤—Ç–æ—Ä:</strong> {{ ticket.user.username }}<br>
                <strong>üìÖ –°–æ–∑–¥–∞–Ω:</strong> {{ ticket.created_at|date:"d.m.Y H:i" }}<br>
                <strong>üîÑ –°—Ç–∞—Ç—É—Å:</strong>
                <span class="ticket-status status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
            </div>
            {% if user.role in 'admin manager' %}
            <div>
                <select id="statusSelect" onchange="updateStatus({{ ticket.id }})" style="padding: 8px; border-radius: 6px; background: #3a3a3a; color: white; border: 1px solid #555;">
                    {% for status_value, status_name in ticket.STATUS_CHOICES %}
                    <option value="{{ status_value }}" {% if ticket.status == status_value %}selected{% endif %}>
                        {{ status_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>

        <div class="ticket-message" style="background: #3a3a3a; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #007bff;">
            <strong style="color: #fff;">üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</strong><br>
            <div style="margin-top: 10px; color: #e0e0e0; line-height: 1.6;">
                {{ ticket.message|linebreaks }}
            </div>
        </div>
    </div>

    <!-- –û–¢–í–ï–¢–´ -->
    <div class="response-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #fff;">üí¨ –û—Ç–≤–µ—Ç—ã ({{ ticket.responses.count }})</h4>
            <button class="btn-reply" onclick="openResponseModal()">
                ‚ú® –û—Ç–≤–µ—Ç–∏—Ç—å
            </button>
        </div>

        <div class="responses-list">
            {% for response in ticket.responses.all %}
            <div class="response-item" style="animation: fadeIn 0.5s ease-in;">
                <div class="response-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: {% if response.user.role in 'admin manager' %}#007bff{% else %}#28a745{% endif %}; display: flex; align-items: center; justify-content: center; font-size: 14px; color: white;">
                            {% if response.user.role in 'admin manager' %}üõ†Ô∏è{% else %}üë§{% endif %}
                        </div>
                        <div>
                            <strong style="color: #fff;">
                                {% if response.user.role in 'admin manager' %}–ü–æ–¥–¥–µ—Ä–∂–∫–∞{% else %}{{ response.user.username }}{% endif %}
                            </strong>
                            <div style="color: #999; font-size: 12px;">{{ response.created_at|date:"d.m.Y H:i" }}</div>
                        </div>
                    </div>
                </div>
                <div class="response-content" style="margin-top: 10px; padding: 15px; background: #3a3a3a; border-radius: 8px; border: 1px solid #555;">
                    {{ response.message|linebreaks }}
                </div>
            </div>
            {% empty %}
            <div class="no-responses" style="text-align: center; padding: 40px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 10px;">üí¨</div>
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ</p>
                <button class="btn-reply" onclick="openResponseModal()">
                    üíå –ù–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –û–¢–í–ï–¢–ê -->
<div id="responseModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; color: #fff;">üí¨ –û—Ç–≤–µ—Ç –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ</h3>
            <span class="close" onclick="closeResponseModal()" style="font-size: 28px; cursor: pointer; color: #ccc; padding: 5px;">&times;</span>
        </div>

        <div style="background: #3a3a3a; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
            <strong style="color: #fff;">–û–±—Ä–∞—â–µ–Ω–∏–µ:</strong>
            <div style="color: #ccc; margin-top: 10px;">{{ ticket.subject }}</div>
        </div>

        <form method="POST" action="{% url 'ticket_detail' ticket.id %}" id="responseForm">
            {% csrf_token %}
            <div class="form-group">
                <label style="display: block; margin-bottom: 10px; color: #ccc; font-weight: bold;">–í–∞—à –æ—Ç–≤–µ—Ç</label>
                <textarea name="response" required
                          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."
                          style="width: 100%; min-height: 200px; padding: 15px; background: #3a3a3a; border: 1px solid #555; border-radius: 10px; color: #fff; font-size: 14px; line-height: 1.5; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                <button type="button" class="btn-cancel" onclick="closeResponseModal()">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" class="btn-send">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    animation: fadeIn 0.3s ease-in;
}

.modal-content {
    background: #2d2d2d;
    margin: 5% auto;
    padding: 30px;
    border-radius: 15px;
    border: 1px solid #404040;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
    animation: slideIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.btn-reply {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

.btn-reply:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,123,255,0.4);
}

.btn-send {
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40,167,69,0.3);
}

.btn-cancel {
    background: #6c757d;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-cancel:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.response-item {
    margin-bottom: 20px;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
function updateStatus(ticketId) {
    const status = document.getElementById('statusSelect').value;

    fetch(`/support/ticket/${ticketId}/update-status/`, {
        method: 'POST',
        body: JSON.stringify({'status': status}),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            showNotification('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    });
}

function openResponseModal() {
    document.getElementById('responseModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
}

function closeResponseModal() {
    document.getElementById('responseModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('responseModal');
    if (event.target === modal) {
        closeResponseModal();
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.getElementById('responseForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    submitBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    submitBtn.disabled = true;

    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            showNotification('‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
            closeResponseModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>